<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reflow - Decision Bottleneck Detector</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <div class="app-container">
        <aside class="sidebar">
            <div class="logo-section">
                <img src="reflow.avif" alt="Reflow Logo" class="logo-img">
                <h1>Reflow</h1>
            </div>
            <div class="nav-section">
                <h2>Navigation</h2>
                <nav>
                    <ul>
                        <li><a href="#" class="nav-link active"><span class="nav-icon">üìã</span> Blocker Detector</a></li>
                        <li><a href="#" class="nav-link"><span class="nav-icon">‚óªÔ∏è</span> Dashboard</a></li>
                        <li><a href="#" class="nav-link"><span class="nav-icon">üìä</span> Reports</a></li>
                        <li><a href="#" class="nav-link"><span class="nav-icon">‚öôÔ∏è</span> Settings</a></li>
                    </ul>
                </nav>
            </div>
            <div class="user-profile-section">
                <div class="user-avatar">JS</div>
                <div class="user-info">
                    <p class="user-name">James Smith</p>
                    <p class="user-role">Product Lead</p>
                </div>
            </div>
        </aside>

        <main class="main-content">
            <header class="main-header">
                <div class="title-group">
                    <h1>Decision Bottleneck Detector</h1>
                    <span class="badge-prototype">PROTOTYPE</span>
                </div>
                <p class="subtitle">Scanning communication channels for blocked work...</p>
            </header>

            <section class="kpi-cards">
                <div class="card">
                    <div class="card-header">
                        <h3>Total Blocked</h3>
                    </div>
                    <div class="big-number" id="total-blocked">0</div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3>Avg. Wait Time</h3>
                    </div>
                    <div class="big-number" id="avg-wait">0h</div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3>Oldest Bottleneck</h3>
                    </div>
                    <div class="big-number" id="max-wait">0h</div>
                </div>
            </section>

            <div class="insight-banner">
                <div id="insight-text">Analyzing data...</div>
            </div>

            <section class="decisions-table-section">
                <div class="table-header">
                    <h2>Decisions</h2>
                    <input type="text" id="searchInput" class="search-bar" placeholder="Search by keyword or author...">
                </div>

                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th width="40%">Decision Context</th>
                                <th width="20%">Asked By</th>
                                <th width="10%">Replies</th>
                                <th width="10%">Wait Time</th>
                                <th width="10%">Status</th>
                                <th width="10%">Action</th> </tr>
                        </thead>
                        <tbody id="decision-table-body">
                            </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <div id="detailModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Thread Details</h2>
                <button class="close-btn" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body" id="modalBody">
                </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal()">Close</button>
                <button class="btn-primary" onclick="triggerToast('Opened in Slack!')">Open in Slack</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast hidden">Notification sent!</div>

    <script src="data.js"></script>

    <script>
        // --- 1. SETUP ---
        const tbody = document.getElementById('decision-table-body');
        const searchInput = document.getElementById('searchInput');
        let processedData = [];

        // --- 2. CORE LOGIC ---
        function isDecisionRequest(text) {
            const lower = text.toLowerCase();
            const keywords = ["should we", "can we", "approve", "do we go ahead"];
            return keywords.some(k => lower.includes(k)) || text.trim().endsWith("?");
        }

        function isResolved(replies) {
            const resolutionWords = ["yes", "approved", "go ahead", "let‚Äôs do it", "let's do it"];
            return replies.some(reply => 
                resolutionWords.some(word => reply.text.toLowerCase().includes(word))
            );
        }

        function getDecisionStatus(diffHours, replyCount) {
            if (diffHours >= 48) return "Critical";
            if (replyCount === 0 && diffHours >= 12) return "Stalled";
            return "Unresolved";
        }

        // --- 3. DATA PROCESSING ---
        function analyzeData() {
            const now = Date.now();
            processedData = [];

            slackData.forEach(msg => {
                if (!isDecisionRequest(msg.text)) return;
                if (isResolved(msg.replies)) return;

                const waitTimeMs = now - msg.timestamp;
                const waitTimeHours = Math.floor(waitTimeMs / (1000 * 60 * 60));
                const status = getDecisionStatus(waitTimeHours, msg.replies.length);

                processedData.push({ ...msg, waitHours: waitTimeHours, status: status });
            });

            // Sort: Critical first, then by wait time
            processedData.sort((a, b) => b.waitHours - a.waitHours);
            
            updateKPIs();
            renderTable(processedData);
        }

        // --- 4. RENDERING & UI ---
        function updateKPIs() {
            const total = processedData.length;
            const avg = total > 0 ? Math.floor(processedData.reduce((a, b) => a + b.waitHours, 0) / total) : 0;
            const max = total > 0 ? Math.max(...processedData.map(d => d.waitHours)) : 0;
            const critical = processedData.filter(d => d.status === "Critical").length;

            document.getElementById('total-blocked').innerText = total;
            document.getElementById('avg-wait').innerText = avg + "h";
            document.getElementById('max-wait').innerText = max + "h";

            const insight = critical > 0 
                ? `üö® <strong>Action Required:</strong> ${critical} critical decisions blocked > 48h.`
                : `‚ÑπÔ∏è <strong>Status:</strong> ${total} decisions pending.`;
            document.getElementById('insight-text').innerHTML = insight;
        }

        function renderTable(data) {
            let html = "";
            data.forEach(item => {
                let badgeClass = "badge-unresolved";
                if (item.status === "Critical") badgeClass = "badge-critical";
                if (item.status === "Stalled") badgeClass = "badge-stalled";

                html += `
                    <tr onclick="openModal('${item.id}')" class="clickable-row">
                        <td>
                            <div class="msg-text">${item.text}</div>
                            <div class="msg-sub"><span class="channel-tag">${item.channel}</span> #${item.id}</div>
                        </td>
                        <td>
                            <div class="author-cell">
                                <div class="avatar-small">${item.author.avatar}</div>
                                <div class="author-meta">
                                    <span>${item.author.name}</span>
                                    <span class="author-role">${item.author.role}</span>
                                </div>
                            </div>
                        </td>
                        <td class="text-center">${item.replies.length}</td>
                        <td class="font-bold">${item.waitHours}h</td>
                        <td><span class="badge ${badgeClass}">${item.status}</span></td>
                        <td>
                            <button class="btn-nudge" onclick="event.stopPropagation(); triggerToast('Nudged ${item.author.name} on Slack!')">
                                Nudge üîî
                            </button>
                        </td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
        }

        // --- 5. INTERACTIVITY (Search, Modal, Toast) ---

        // Search Listener
        searchInput.addEventListener('keyup', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = processedData.filter(item => 
                item.text.toLowerCase().includes(term) || 
                item.author.name.toLowerCase().includes(term)
            );
            renderTable(filtered);
        });

        // Modal Logic
        function openModal(id) {
            const item = processedData.find(d => d.id === id);
            if(!item) return;

            const modal = document.getElementById('detailModal');
            const body = document.getElementById('modalBody');
            
            // Build Thread View
            let repliesHtml = item.replies.map(r => `
                <div class="thread-reply">
                    <strong>${r.author}:</strong> ${r.text}
                    <div class="time-ago">Earlier today</div>
                </div>
            `).join('');

            if(item.replies.length === 0) repliesHtml = `<div class="no-replies">No replies yet.</div>`;

            body.innerHTML = `
                <div class="thread-main">
                    <div class="thread-meta">${item.author.name} asked in ${item.channel}:</div>
                    <div class="thread-question">"${item.text}"</div>
                </div>
                <div class="thread-list">
                    ${repliesHtml}
                </div>
            `;
            
            modal.classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('detailModal').classList.add('hidden');
        }

        // Toast Notification
        function triggerToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        // Init
        analyzeData();
    </script>
</body>
</html>
