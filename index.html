<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reflow - Decision Bottleneck Detector</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <div class="app-container">
        <aside class="sidebar">
            <div class="logo-section">
                <img src="reflow.avif" alt="Reflow Logo" class="logo-img">
                <h1>Reflow</h1>
            </div>
            <div class="nav-section">
                <h2>Navigation</h2>
                <nav>
                    <ul>
                        <li><a href="#" class="nav-link active"><span class="nav-icon">üìã</span> Blocker Detector</a></li>
                        <li><a href="#" class="nav-link"><span class="nav-icon">‚óªÔ∏è</span> Dashboard</a></li>
                        <li><a href="#" class="nav-link"><span class="nav-icon">üìä</span> Reports</a></li>
                        <li><a href="#" class="nav-link"><span class="nav-icon">‚öôÔ∏è</span> Settings</a></li>
                    </ul>
                </nav>
            </div>
            <div class="user-profile-section">
                <div class="user-avatar">JS</div>
                <div class="user-info">
                    <p class="user-name">James Smith</p>
                    <p class="user-role">Product Lead</p>
                </div>
            </div>
        </aside>

        <main class="main-content">
            <header class="main-header">
                <div class="title-group">
                    <h1>Decision Bottleneck Detector</h1>
                    <span class="badge-prototype">PROTOTYPE</span>
                </div>
                <p class="subtitle">Scanning communication channels for blocked work...</p>
            </header>

            <section class="kpi-cards">
                <div class="card">
                    <div class="card-header">
                        <h3>Total Blocked</h3>
                    </div>
                    <div class="big-number" id="total-blocked">0</div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3>Avg. Wait Time</h3>
                    </div>
                    <div class="big-number" id="avg-wait">0h</div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3>Oldest Bottleneck</h3>
                    </div>
                    <div class="big-number" id="max-wait">0h</div>
                </div>
            </section>

            <div class="insight-banner">
                <div id="insight-text">Analyzing data...</div>
            </div>

            <section class="decisions-table-section">
                
                <div class="table-controls">
                    <div class="tabs">
                        <button class="tab-btn active" onclick="setFilter('all')">All Decisions</button>
                        <button class="tab-btn" onclick="setFilter('critical')">üî• Critical</button>
                        <button class="tab-btn" onclick="setFilter('stalled')">‚ö†Ô∏è Stalled</button>
                        <button class="tab-btn" onclick="setFilter('me')">üë§ My Requests</button>
                    </div>
                    
                    <input type="text" id="searchInput" class="search-bar" placeholder="Search...">
                </div>

                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th width="40%">Decision Context</th>
                                <th width="20%">Asked By</th>
                                <th width="10%" class="text-center">Replies</th>
                                <th width="15%">Urgency (48h Limit)</th>
                                <th width="10%">Status</th>
                                <th width="5%"></th>
                            </tr>
                        </thead>
                        <tbody id="decision-table-body">
                            </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <div id="detailModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Thread Details</h2>
                <button class="close-btn" onclick="closeModal('detailModal')">√ó</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('detailModal')">Close</button>
                <button class="btn-primary" onclick="triggerToast('Opened in Slack!')">Open in Slack</button>
            </div>
        </div>
    </div>

    <div id="nudgeModal" class="modal-overlay hidden">
        <div class="modal-content small-modal">
            <div class="modal-header">
                <h2>Send Nudge</h2>
                <button class="close-btn" onclick="closeModal('nudgeModal')">√ó</button>
            </div>
            <div class="modal-body">
                <p class="input-label">Message to <strong id="nudgeTargetName">User</strong>:</p>
                <textarea id="nudgeMessage" class="nudge-textarea">Hey! Just bumping this decision request. It's blocking the sprint.</textarea>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('nudgeModal')">Cancel</button>
                <button class="btn-primary" onclick="sendNudge()">Send Nudge üöÄ</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast hidden">Notification sent!</div>

    <script src="data.js"></script>
    <script>
        // --- CONFIG & STATE ---
        const tbody = document.getElementById('decision-table-body');
        const searchInput = document.getElementById('searchInput');
        let allData = [];
        let currentFilter = 'all';

        // --- LOGIC ---
        function isDecisionRequest(text) {
            const lower = text.toLowerCase();
            const keywords = ["should we", "can we", "approve", "do we go ahead"];
            return keywords.some(k => lower.includes(k)) || text.trim().endsWith("?");
        }

        function isResolved(replies) {
            const resolutionWords = ["yes", "approved", "go ahead", "let‚Äôs do it", "let's do it"];
            return replies.some(reply => 
                resolutionWords.some(word => reply.text.toLowerCase().includes(word))
            );
        }

        function getDecisionStatus(diffHours, replyCount) {
            if (diffHours >= 48) return "Critical";
            if (replyCount === 0 && diffHours >= 12) return "Stalled";
            return "Unresolved";
        }

        // --- PROCESSING ---
        function analyzeData() {
            const now = Date.now();
            allData = [];

            slackData.forEach(msg => {
                if (!isDecisionRequest(msg.text)) return;
                if (isResolved(msg.replies)) return;

                const waitTimeMs = now - msg.timestamp;
                const waitTimeHours = Math.floor(waitTimeMs / (1000 * 60 * 60));
                const status = getDecisionStatus(waitTimeHours, msg.replies.length);
                
                // Calculate Urgency % (Max 48 hours)
                let urgencyPct = (waitTimeHours / 48) * 100;
                if(urgencyPct > 100) urgencyPct = 100;

                allData.push({ 
                    ...msg, 
                    waitHours: waitTimeHours, 
                    status: status,
                    urgencyPct: urgencyPct
                });
            });

            // Sort: Critical first
            allData.sort((a, b) => b.waitHours - a.waitHours);
            
            updateKPIs();
            renderTable();
        }

        // --- RENDER ---
        function setFilter(filterType) {
            currentFilter = filterType;
            
            // Update Tab UI
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            renderTable();
        }

        function renderTable() {
            // 1. Filter Logic
            const term = searchInput.value.toLowerCase();
            let displayData = allData.filter(item => {
                // Text Search
                const matchesSearch = item.text.toLowerCase().includes(term) || item.author.name.toLowerCase().includes(term);
                
                // Tab Filter
                let matchesTab = true;
                if(currentFilter === 'critical') matchesTab = item.status === 'Critical';
                if(currentFilter === 'stalled') matchesTab = item.status === 'Stalled';
                if(currentFilter === 'me') matchesTab = item.author.name === 'James Smith'; // Mock "Me"
                
                return matchesSearch && matchesTab;
            });

            // 2. HTML Generation
            let html = "";
            if(displayData.length === 0) {
                html = `<tr><td colspan="6" class="empty-state">No decisions found matching filters.</td></tr>`;
            } else {
                displayData.forEach(item => {
                    let badgeClass = "badge-unresolved";
                    let progressBarClass = "progress-blue";
                    
                    if (item.status === "Critical") {
                        badgeClass = "badge-critical";
                        progressBarClass = "progress-red";
                    } else if (item.status === "Stalled") {
                        badgeClass = "badge-stalled";
                        progressBarClass = "progress-yellow";
                    }

                    html += `
                        <tr onclick="openDetailModal('${item.id}')" class="clickable-row">
                            <td>
                                <div class="msg-text">${item.text}</div>
                                <div class="msg-sub"><span class="channel-tag">${item.channel}</span> #${item.id}</div>
                            </td>
                            <td>
                                <div class="author-cell">
                                    <div class="avatar-small">${item.author.avatar}</div>
                                    <div class="author-meta">
                                        <span>${item.author.name}</span>
                                        <span class="author-role">${item.author.role}</span>
                                    </div>
                                </div>
                            </td>
                            <td class="text-center">${item.replies.length}</td>
                            <td>
                                <div class="urgency-wrapper">
                                    <div class="urgency-text">${item.waitHours} hrs</div>
                                    <div class="progress-track">
                                        <div class="progress-fill ${progressBarClass}" style="width: ${item.urgencyPct}%"></div>
                                    </div>
                                </div>
                            </td>
                            <td><span class="badge ${badgeClass}">${item.status}</span></td>
                            <td>
                                <button class="btn-icon" onclick="event.stopPropagation(); openNudgeModal('${item.author.name}')" title="Nudge User">
                                    üîî
                                </button>
                            </td>
                        </tr>
                    `;
                });
            }
            tbody.innerHTML = html;
        }

        function updateKPIs() {
            const total = allData.length;
            const avg = total > 0 ? Math.floor(allData.reduce((a, b) => a + b.waitHours, 0) / total) : 0;
            const critical = allData.filter(d => d.status === "Critical").length;

            document.getElementById('total-blocked').innerText = total;
            document.getElementById('avg-wait').innerText = avg + "h";
            document.getElementById('max-wait').innerText = (total > 0 ? Math.max(...allData.map(d => d.waitHours)) : 0) + "h";
            
            const insight = critical > 0 
                ? `üö® <strong>Action Required:</strong> ${critical} critical decisions blocked > 48h.`
                : `‚ÑπÔ∏è <strong>Status:</strong> ${total} decisions pending.`;
            document.getElementById('insight-text').innerHTML = insight;
        }

        // --- INTERACTION ---
        searchInput.addEventListener('keyup', renderTable);

        // Details Modal
        function openDetailModal(id) {
            const item = allData.find(d => d.id === id);
            if(!item) return;

            const body = document.getElementById('modalBody');
            let repliesHtml = item.replies.map(r => `
                <div class="thread-reply">
                    <div class="reply-header">
                        <strong>${r.author}</strong> <span class="time-ago">replied earlier</span>
                    </div>
                    ${r.text}
                </div>
            `).join('');

            if(item.replies.length === 0) repliesHtml = `<div class="no-replies">No replies yet. This thread is stalled.</div>`;

            body.innerHTML = `
                <div class="thread-main">
                    <div class="thread-meta">${item.author.name} asked in <span class="channel-tag">${item.channel}</span></div>
                    <div class="thread-question">"${item.text}"</div>
                </div>
                <div class="thread-list">
                    <h4>Thread History</h4>
                    ${repliesHtml}
                </div>
            `;
            document.getElementById('detailModal').classList.remove('hidden');
        }

        // Nudge Modal
        function openNudgeModal(name) {
            document.getElementById('nudgeTargetName').innerText = name;
            document.getElementById('nudgeModal').classList.remove('hidden');
        }

        function sendNudge() {
            const name = document.getElementById('nudgeTargetName').innerText;
            closeModal('nudgeModal');
            triggerToast(`Nudge sent to ${name} via Slack!`);
        }

        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
        }

        function triggerToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        // Init
        analyzeData();
    </script>
</body>
</html>
