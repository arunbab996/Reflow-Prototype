<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reflow - Decision Bottleneck Detector</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <div class="app-container">
        <aside class="sidebar">
            <div class="logo-section">
                <a href="#" class="logo-link" onclick="location.reload()">
                    <img src="reflow.avif" alt="Reflow Logo" class="logo-img">
                    <h1>Reflow</h1>
                </a>
            </div>
            <div class="nav-section">
                <h2>Navigation</h2>
                <nav>
                    <ul>
                        <li><a href="#" class="nav-link active">
                            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                            Blocker Detector
                        </a></li>
                        <li><a href="#" class="nav-link">
                            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                            Dashboard
                        </a></li>
                        <li><a href="#" class="nav-link">
                            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
                            Reports
                        </a></li>
                        <li><a href="#" class="nav-link">
                            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1Z"></path></svg>
                            Settings
                        </a></li>
                    </ul>
                </nav>
            </div>
            <div class="user-profile-section">
                <img src="https://i.pravatar.cc/150?img=3" alt="User" class="user-avatar">
                <div class="user-info">
                    <p class="user-name">James Smith</p>
                    <p class="user-role">Product Lead</p>
                </div>
            </div>
        </aside>

        <main class="main-content">
            <header class="main-header">
                <div class="title-group">
                    <h1>Decision Bottleneck Detector</h1>
                    <span class="badge-prototype">PROTOTYPE</span>
                </div>
                <p class="subtitle">Scanning communication channels for blocked work...</p>
                <div class="reset-link" onclick="resetDemo()">Reset Demo Data</div>
            </header>

            <section class="kpi-cards">
                <div class="card">
                    <div class="card-header"><h3>Total Blocked</h3></div>
                    <div class="big-number" id="total-blocked">...</div>
                </div>
                <div class="card">
                    <div class="card-header"><h3>Avg. Wait Time</h3></div>
                    <div class="big-number" id="avg-wait">...</div>
                </div>
                <div class="card">
                    <div class="card-header"><h3>Oldest Bottleneck</h3></div>
                    <div class="big-number" id="max-wait">...</div>
                </div>
            </section>

            <div class="insight-banner">
                <div id="insight-text">
                    <div class="skeleton-line" style="width: 60%;"></div>
                </div>
            </div>

            <section class="decisions-table-section">
                
                <div class="table-controls">
                    <div class="tabs">
                        <button class="tab-btn active" onclick="setFilter('all')">All Decisions</button>
                        <button class="tab-btn" onclick="setFilter('critical')">üî• Critical</button>
                        <button class="tab-btn" onclick="setFilter('stalled')">‚ö†Ô∏è Stalled</button>
                        <button class="tab-btn" onclick="setFilter('me')">üë§ My Requests</button>
                    </div>
                    
                    <input type="text" id="searchInput" class="search-bar" placeholder="Search...">
                </div>

                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th width="35%" onclick="sortData('text')"><div class="th-content">Decision Context <svg class="sort-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M7 15l5 5 5-5"/><path d="M7 9l5-5 5 5"/></svg></div></th>
                                <th width="20%" onclick="sortData('author')"><div class="th-content">Asked By <svg class="sort-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M7 15l5 5 5-5"/><path d="M7 9l5-5 5 5"/></svg></div></th>
                                <th width="10%" class="text-center">Replies</th>
                                <th width="15%" onclick="sortData('waitHours')"><div class="th-content">Urgency <svg class="sort-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M7 15l5 5 5-5"/><path d="M7 9l5-5 5 5"/></svg></div></th>
                                <th width="10%" onclick="sortData('status')"><div class="th-content">Status <svg class="sort-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M7 15l5 5 5-5"/><path d="M7 9l5-5 5 5"/></svg></div></th>
                                <th width="10%">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="decision-table-body">
                            </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <div id="detailModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Thread Details</h2>
                <button class="close-btn" onclick="closeModal('detailModal')">√ó</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('detailModal')">Close</button>
                <div id="modalActions">
                    </div>
            </div>
        </div>
    </div>

    <div id="nudgeModal" class="modal-overlay hidden">
        <div class="modal-content small-modal">
            <div class="modal-header">
                <h2>Send Nudge</h2>
                <button class="close-btn" onclick="closeModal('nudgeModal')">√ó</button>
            </div>
            <div class="modal-body">
                <p class="input-label">Message to <strong id="nudgeTargetName">User</strong>:</p>
                <textarea id="nudgeMessage" class="nudge-textarea">Hey! Just bumping this decision request. It's blocking the sprint.</textarea>
            </div>
            <div class="modal-footer" style="justify-content: flex-end;">
                <button class="btn-secondary" onclick="closeModal('nudgeModal')">Cancel</button>
                <button class="btn-primary" style="margin-left: 10px;" onclick="sendNudge()">Send Nudge üöÄ</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast hidden">Notification sent!</div>

    <script src="data.js"></script>
    <script>
        // --- CONFIG ---
        const tbody = document.getElementById('decision-table-body');
        const searchInput = document.getElementById('searchInput');
        let allData = [];
        let currentFilter = 'all';
        let currentSort = { field: 'waitHours', dir: 'desc' };

        // --- SKELETON LOADER ---
        function renderSkeleton() {
            let html = "";
            for(let i=0; i<5; i++) {
                html += `
                    <tr>
                        <td><div class="skeleton-line" style="width: 80%"></div><div class="skeleton-line" style="width: 40%"></div></td>
                        <td><div style="display:flex; gap:10px; align-items:center"><div class="skeleton-circle"></div><div class="skeleton-line" style="width: 80px"></div></div></td>
                        <td><div class="skeleton-line" style="width: 20px; margin:auto"></div></td>
                        <td><div class="skeleton-line" style="width: 90%"></div></td>
                        <td><div class="skeleton-line" style="width: 60px; height: 20px; border-radius:10px"></div></td>
                        <td><div class="skeleton-line" style="width: 30px; height: 30px; border-radius:4px"></div></td>
                    </tr>
                `;
            }
            tbody.innerHTML = html;
        }

        // --- CORE LOGIC ---
        function getResolvedIds() {
            return JSON.parse(localStorage.getItem('resolvedIds') || '[]');
        }

        function loadDataWithDelay() {
            // Show skeleton first
            renderSkeleton();
            
            // Simulate 1.2s network delay for realism
            setTimeout(() => {
                analyzeData();
            }, 1200);
        }

        function analyzeData() {
            const now = Date.now();
            const resolvedIds = getResolvedIds();
            allData = [];

            slackData.forEach(msg => {
                if(resolvedIds.includes(msg.id)) return;

                const waitTimeMs = now - msg.timestamp;
                const waitTimeHours = Math.floor(waitTimeMs / (1000 * 60 * 60));
                
                let status = "Unresolved";
                if (waitTimeHours >= 48) status = "Critical";
                else if (msg.replies.length === 0 && waitTimeHours >= 12) status = "Stalled";
                
                let urgencyPct = (waitTimeHours / 48) * 100;
                if(urgencyPct > 100) urgencyPct = 100;

                allData.push({ 
                    ...msg, 
                    waitHours: waitTimeHours, 
                    status: status,
                    urgencyPct: urgencyPct
                });
            });

            doSort();
            updateKPIs();
            renderTable();
        }

        function doSort() {
            allData.sort((a, b) => {
                let valA = a[currentSort.field];
                let valB = b[currentSort.field];
                if(currentSort.field === 'author') { valA = a.author.name; valB = b.author.name; }
                if (valA < valB) return currentSort.dir === 'asc' ? -1 : 1;
                if (valA > valB) return currentSort.dir === 'asc' ? 1 : -1;
                return 0;
            });
        }

        function setFilter(filterType) {
            currentFilter = filterType;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderTable(); // Instant render for filter switch
        }

        function renderTable() {
            const term = searchInput.value.toLowerCase();
            let displayData = allData.filter(item => {
                const matchesSearch = item.text.toLowerCase().includes(term) || item.author.name.toLowerCase().includes(term);
                let matchesTab = true;
                if(currentFilter === 'critical') matchesTab = item.status === 'Critical';
                if(currentFilter === 'stalled') matchesTab = item.status === 'Stalled';
                if(currentFilter === 'me') matchesTab = item.author.name === 'James Smith';
                return matchesSearch && matchesTab;
            });

            let html = "";
            if(displayData.length === 0) {
                html = `<tr><td colspan="6" class="empty-state">No active decisions found.</td></tr>`;
            } else {
                displayData.forEach(item => {
                    let badgeClass = "badge-unresolved";
                    let progressBarClass = "progress-blue";
                    if (item.status === "Critical") { badgeClass = "badge-critical"; progressBarClass = "progress-red"; } 
                    else if (item.status === "Stalled") { badgeClass = "badge-stalled"; progressBarClass = "progress-yellow"; }

                    html += `
                        <tr id="row-${item.id}" onclick="openDetailModal('${item.id}')" class="clickable-row">
                            <td>
                                <div class="msg-text">${item.text}</div>
                                <div class="msg-sub"><span class="channel-tag">${item.channel}</span> #${item.id}</div>
                            </td>
                            <td>
                                <div class="author-cell">
                                    <img src="${item.author.avatar}" class="avatar-small">
                                    <div class="author-meta">
                                        <span>${item.author.name}</span>
                                        <span class="author-role">${item.author.role}</span>
                                    </div>
                                </div>
                            </td>
                            <td class="text-center">${item.replies.length}</td>
                            <td>
                                <div class="urgency-wrapper">
                                    <div class="urgency-text">${item.waitHours} hrs</div>
                                    <div class="progress-track">
                                        <div class="progress-fill ${progressBarClass}" style="width: ${item.urgencyPct}%"></div>
                                    </div>
                                </div>
                            </td>
                            <td><span class="badge ${badgeClass}">${item.status}</span></td>
                            <td>
                                <div style="display:flex; gap: 8px;">
                                    <button class="btn-icon" onclick="event.stopPropagation(); openNudgeModal('${item.author.name}')" title="Nudge User">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
                                    </button>
                                    <button class="btn-icon btn-check" onclick="event.stopPropagation(); resolveDecision('${item.id}', true)" title="Mark Resolved">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
            }
            tbody.innerHTML = html;
        }

        function updateKPIs() {
            const total = allData.length;
            const avg = total > 0 ? Math.floor(allData.reduce((a, b) => a + b.waitHours, 0) / total) : 0;
            const critical = allData.filter(d => d.status === "Critical").length;

            document.getElementById('total-blocked').innerText = total;
            document.getElementById('avg-wait').innerText = avg + "h";
            document.getElementById('max-wait').innerText = (total > 0 ? Math.max(...allData.map(d => d.waitHours)) : 0) + "h";
            
            const insight = critical > 0 
                ? `üö® <strong>Action Required:</strong> ${critical} critical decisions blocked > 48h.`
                : `‚ÑπÔ∏è <strong>Status:</strong> ${total} decisions pending.`;
            document.getElementById('insight-text').innerHTML = insight;
        }

        function resolveDecision(id, fromRow) {
            closeModal('detailModal');
            if(fromRow) {
                const row = document.getElementById(`row-${id}`);
                if(row) row.classList.add('row-fading-out');
            }
            const resolved = getResolvedIds();
            resolved.push(id);
            localStorage.setItem('resolvedIds', JSON.stringify(resolved));

            setTimeout(() => {
                analyzeData();
                triggerToast('Decision marked as resolved!', true);
            }, fromRow ? 500 : 0);
        }

        function resetDemo() {
            localStorage.removeItem('resolvedIds');
            location.reload();
        }

        function openDetailModal(id) {
            const item = allData.find(d => d.id === id);
            if(!item) return;

            const body = document.getElementById('modalBody');
            const getTime = (hAgo) => {
                const date = new Date(Date.now() - hAgo * 60 * 60 * 1000);
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            };

            let mainMsgHtml = `
                <div class="slack-msg">
                    <img src="${item.author.avatar}" class="slack-avatar">
                    <div class="slack-content">
                        <div class="slack-meta">
                            <span class="slack-name">${item.author.name}</span>
                            <span class="slack-time">${getTime(item.waitHours)}</span>
                            <span class="slack-channel-badge">${item.channel}</span>
                        </div>
                        <div class="slack-text">${item.text}</div>
                    </div>
                </div>
            `;
            let repliesHtml = item.replies.map(r => `
                <div class="slack-msg">
                    <img src="${r.avatar}" class="slack-avatar">
                    <div class="slack-content">
                        <div class="slack-meta">
                            <span class="slack-name">${r.author}</span>
                            <span class="slack-time">today at ${getTime(1)}</span>
                        </div>
                        <div class="slack-text">${r.text}</div>
                    </div>
                </div>
            `).join('');

            if(item.replies.length === 0) repliesHtml = `<div class="no-replies">No replies yet.</div>`;
            body.innerHTML = `<div class="slack-thread">${mainMsgHtml}<div class="slack-divider"><span>${item.replies.length} replies</span></div>${repliesHtml}</div>`;
            
            // --- FIX FOR BUTTON ALIGNMENT ---
            // Added flex container for right-side buttons
            document.getElementById('modalActions').innerHTML = `
                <div style="display: flex; gap: 10px;">
                    <button class="btn-primary" onclick="triggerToast('Opened in Slack!', false)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="16" height="16"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
                        Open in Slack
                    </button>
                    <button class="btn-success" style="margin-left:0;" onclick="resolveDecision('${item.id}', false)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="16" height="16"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        Mark Resolved
                    </button>
                </div>
            `;
            document.getElementById('detailModal').classList.remove('hidden');
        }

        // Generic
        function sortData(field) {
            if(currentSort.field === field) currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc';
            else { currentSort.field = field; currentSort.dir = 'desc'; }
            doSort(); renderTable();
        }
        function openNudgeModal(name) {
            document.getElementById('nudgeTargetName').innerText = name;
            document.getElementById('nudgeModal').classList.remove('hidden');
        }
        function sendNudge() {
            const name = document.getElementById('nudgeTargetName').innerText;
            closeModal('nudgeModal');
            triggerToast(`Nudge sent to ${name} via Slack!`, false);
        }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function triggerToast(msg, isSuccess) {
            const toast = document.getElementById('toast');
            toast.innerText = msg; toast.className = "toast"; 
            if(isSuccess) toast.classList.add('success');
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }
        searchInput.addEventListener('keyup', renderTable);

        // STARTUP
        loadDataWithDelay(); 
    </script>
</body>
</html>
